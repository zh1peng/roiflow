% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prep_data.R
\name{prep}
\alias{prep}
\title{Preprocess ROI Data}
\usage{
prep(
  df,
  spec = prep_spec(),
  return = c("data", "result"),
  verbose = interactive(),
  strict = FALSE
)
}
\arguments{
\item{df}{Data frame containing ROI measurements and covariates.}

\item{spec}{Preprocessing specification created by \code{\link{prep_spec}}.
Default uses standard settings for L_/R_ prefixed ROI columns.}

\item{return}{Character. What to return:
\itemize{
  \item \code{"data"}: Return only the cleaned data frame (default)
  \item \code{"result"}: Return full result object with data, QC metrics, and logs
}}

\item{verbose}{Logical. Print progress summary. Default: \code{TRUE} in interactive
sessions, \code{FALSE} otherwise.}

\item{strict}{Logical. If \code{TRUE}, stop on warnings (e.g., missing reference
levels, no ROI columns). Default: \code{FALSE}.}
}
\value{
If \code{return = "data"}: A cleaned data frame.

If \code{return = "result"}: An object of class \code{roiflow_prep_result} containing:
\itemize{
  \item \code{data}: Cleaned data frame
  \item \code{qc}: List of quality control metrics:
    \itemize{
      \item \code{n_rows_in}, \code{n_rows_out}: Input/output row counts
      \item \code{n_cols_in}, \code{n_cols_out}: Input/output column counts
      \item \code{n_roi_cols}: Number of ROI columns detected
      \item \code{n_rows_dropped_na}: Rows removed due to missing data
      \item \code{n_zero_to_na}: Number of zeros converted to NA
      \item \code{n_outlier_points}: Total outlier values detected/clipped
      \item \code{outliers_per_roi}: Named vector of outlier counts per ROI
      \item \code{outlier_index}: List of row indices per ROI (after NA filtering)
      \item \code{required_cols}: Columns used for completeness check
    }
  \item \code{log}: List of log entries with codes, messages, and context
  \item \code{spec}: The preprocessing specification used
}
}
\description{
Main preprocessing function for ROI-based neuroimaging data. Performs a
comprehensive, configurable pipeline including type conversion, rescaling,
factor handling, missing data management, and outlier detection/clipping.

This function is designed to be both human and LLM-agent friendly with:
\itemize{
  \item Flexible configuration via \code{\link{prep_spec}}
  \item Detailed logging of all operations
  \item Quality control metrics
  \item Informative error messages
  \item Option to return full result object or just cleaned data
}
}
\details{
The preprocessing pipeline executes these steps in order:

\strong{1. Column Identification}
\itemize{
  \item Identifies ROI columns using \code{roi_regex}
  \item Identifies numeric columns using \code{numeric_regex}
  \item Identifies zero-to-NA columns using \code{zero_to_na_regex}
}

\strong{2. Type Conversion}
\itemize{
  \item Converts matched columns to numeric
  \item Tracks new NAs introduced by coercion
  \item Logs warnings for problematic conversions
}

\strong{3. ICV Rescaling}
\itemize{
  \item Divides ICV by \code{icv_scale} (default: 1,000,000)
  \item Useful for numerical stability in models
}

\strong{4. Factor Handling}
\itemize{
  \item Converts specified columns to factors
  \item Sets reference levels (e.g., Sex = "0", Group = "0")
  \item For Site: optionally sets largest site as reference
  \item Warns if specified reference levels don't exist
}

\strong{5. Zero to NA Conversion}
\itemize{
  \item Converts zeros to NA in ROI and ICV columns
  \item Common in neuroimaging when 0 indicates missing/failed measurement
}

\strong{6. Missing Data Handling}
\itemize{
  \item \code{na_action = "drop_required"}: Removes rows with NA in required columns
  \item \code{na_action = "drop_all"}: Removes rows with any NA
  \item \code{na_action = "keep"}: Keeps all rows
  \item Required columns auto-detected from key covariates if not specified
}

\strong{7. Outlier Detection/Clipping}
\itemize{
  \item IQR method: Outliers beyond Q1 - k*IQR or Q3 + k*IQR
  \item SD method: Outliers beyond mean Â± k*SD
  \item \code{outlier_action = "clip"}: Clips to fence boundaries
  \item \code{outlier_action = "flag"}: Detects but doesn't modify
  \item Applied only to ROI columns
}
}
\section{Log Codes}{

The log uses structured codes for programmatic parsing:
\itemize{
  \item \code{W_*}: Warnings (e.g., \code{W_NO_ROI_COLS}, \code{W_NUMERIC_COERCE_NA})
  \item \code{I_*}: Informational (e.g., \code{I_ICV_RESCALE}, \code{I_FACTOR_RELEVEL})
}
}

\examples{
\dontrun{
# Basic usage - returns cleaned data
clean_data <- prep(raw_data)

# Get full result with QC metrics and logs
result <- prep(raw_data, return = "result")
print(result)
summary(result$qc)
View(result$log)

# Custom specification
spec <- prep_spec(
  outlier_k = 2.5,
  na_action = "drop_all",
  site_ref = "SITE_A"
)
clean_data <- prep(raw_data, spec = spec)

# Strict mode - stop on warnings
clean_data <- prep(raw_data, strict = TRUE)

# Silent mode
clean_data <- prep(raw_data, verbose = FALSE)
}

}
\seealso{
\code{\link{prep_spec}} for creating preprocessing specifications
}
