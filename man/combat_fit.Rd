% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/combat_core.R
\name{combat_fit}
\alias{combat_fit}
\title{Fit a ComBat Harmonization Model}
\usage{
combat_fit(
  dat,
  batch,
  mod = NULL,
  eb = TRUE,
  verbose = TRUE,
  single_batch = c("error", "return")
)
}
\arguments{
\item{dat}{Numeric matrix or data frame. Either rows or columns must match
the length of \code{batch}. If subjects are rows, the data are transposed
internally. Features are assumed to be rows after any transpose.}

\item{batch}{Factor indicating batch/site per subject. Must be a factor; unused
levels are dropped with a warning.}

\item{mod}{Optional numeric design matrix of covariates (no intercept required).
Must have the same number of rows as \code{length(batch)} when provided.}

\item{eb}{Logical. If \code{TRUE}, use empirical Bayes shrinkage (default).}

\item{verbose}{Logical. Print progress messages.}

\item{single_batch}{Character. What to do if there is only one batch level:
\code{"error"} (default) stops; \code{"return"} returns a no-op model that
will pass data through unchanged in \code{\link{combat_apply}}.}
}
\value{
A list containing the fitted model components, including:
\itemize{
  \item \code{levels_batch}: factor levels used during fit
  \item \code{transpose}: whether the input was transposed
  \item \code{not_constant}: indices of non-constant features
  \item \code{eb}: whether EB was used
  \item \code{tmp2}, \code{tmp4}: internal fitted statistics
  \item \code{mod_info}: metadata for validating apply-time covariates
}
}
\description{
Fits a ComBat batch harmonization model to a numeric matrix, with optional
covariates. This implementation is adapted from the \code{sva} package with
MRI-focused modifications and robustness patches. It supports missing values
(imputation during fit), constant-feature handling, and optional empirical
Bayes (EB) shrinkage.
}
\details{
Missing values are imputed during fit. If \code{mod} is \code{NULL}, missing
values are imputed using within-batch means with a global-mean fallback; a
warning is emitted to make this behavior explicit. If \code{mod} is provided,
a regression-based imputation is used (mirroring the original ComBat logic).

Features with zero (or undefined) variance are filtered out prior to fitting.
}
\seealso{
\code{\link{combat_apply}} for applying a fitted model.
}
